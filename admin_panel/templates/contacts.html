{% extends "base.html" %}

{% block title %}Contatos - NEXOR Admin{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1><i class="fas fa-envelope me-2"></i>Gerenciamento de Contatos</h1>
    <div class="btn-group" role="group">
        <button type="button" class="btn btn-outline-primary" onclick="filterContacts('all')">Todos</button>
        <button type="button" class="btn btn-outline-warning" onclick="filterContacts('pending')">Pendentes</button>
        <button type="button" class="btn btn-outline-success" onclick="filterContacts('responded')">Respondidos</button>
    </div>
</div>

{% if contacts %}
<div class="row">
    {% for contact in contacts %}
    <div class="col-md-6 mb-4 contact-card" data-status="{{ contact[6] }}">
        <div class="card h-100">
            <div class="card-header d-flex justify-content-between align-items-center">
                <div>
                    <h5 class="mb-0">{{ contact[1] }}</h5>
                    <small class="text-muted">{{ contact[2] }}</small>
                </div>
                <div>
                    {% if contact[6] == 'pending' %}
                        <span class="badge bg-warning">Pendente</span>
                    {% else %}
                        <span class="badge bg-success">Respondido</span>
                    {% endif %}
                </div>
            </div>
            <div class="card-body">
                <h6 class="card-subtitle mb-2 text-muted">
                    <i class="fas fa-tag me-1"></i>{{ contact[3] }}
                </h6>
                <p class="card-text">{{ contact[4] }}</p>
                
                {% if contact[7] %}
                <div class="alert alert-info mt-3">
                    <h6><i class="fas fa-reply me-1"></i>Sua Resposta:</h6>
                    <p class="mb-0">{{ contact[7] }}</p>
                </div>
                {% endif %}
                
                <div class="mt-3">
                    <small class="text-muted">
                        <i class="fas fa-clock me-1"></i>Recebido em: {{ contact[5] }}
                    </small>
                </div>
            </div>
            {% if contact[6] == 'pending' %}
            <div class="card-footer">
                <button class="btn btn-primary btn-sm" onclick="openResponseModal({{ contact[0] }}, '{{ contact[1] }}', '{{ contact[2] }}')">
                    <i class="fas fa-reply me-1"></i>Responder
                </button>
                <a href="mailto:{{ contact[2] }}?subject=Re: {{ contact[3] }}" class="btn btn-outline-secondary btn-sm">
                    <i class="fas fa-external-link-alt me-1"></i>Email Direto
                </a>
            </div>
            {% endif %}
        </div>
    </div>
    {% endfor %}
</div>
{% else %}
<div class="text-center py-5">
    <i class="fas fa-inbox fa-4x text-muted mb-3"></i>
    <h3 class="text-muted">Nenhum contato encontrado</h3>
    <p class="text-muted">Quando alguém entrar em contato através do site, as mensagens aparecerão aqui.</p>
</div>
{% endif %}

<!-- Modal de Resposta -->
<div class="modal fade" id="responseModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-reply me-2"></i>Responder Contato
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="responseForm" method="POST">
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label"><strong>Para:</strong></label>
                        <p id="contactInfo" class="text-muted"></p>
                    </div>
                    <div class="mb-3">
                        <label for="response" class="form-label">Sua Resposta:</label>
                        <textarea class="form-control" id="response" name="response" rows="6" required placeholder="Digite sua resposta aqui..."></textarea>
                    </div>
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        <strong>Dica:</strong> Esta resposta será salva no sistema. Para enviar por email, use o botão "Email Direto" no cartão do contato.
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-1"></i>Cancelar
                    </button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-paper-plane me-1"></i>Enviar Resposta
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let currentContactId = null;

function openResponseModal(contactId, name, email) {
    currentContactId = contactId;
    document.getElementById('contactInfo').textContent = `${name} (${email})`;
    document.getElementById('response').value = '';
    
    // Atualizar action do formulário
    document.getElementById('responseForm').action = `/contacts/respond/${contactId}`;
    
    // Abrir modal
    const modal = new bootstrap.Modal(document.getElementById('responseModal'));
    modal.show();
}

function filterContacts(status) {
    const cards = document.querySelectorAll('.contact-card');
    const buttons = document.querySelectorAll('.btn-group .btn');
    
    // Atualizar botões
    buttons.forEach(btn => btn.classList.remove('active'));
    event.target.classList.add('active');
    
    // Filtrar cartões
    cards.forEach(card => {
        if (status === 'all' || card.dataset.status === status) {
            card.style.display = 'block';
            card.style.animation = 'fadeIn 0.3s ease';
        } else {
            card.style.display = 'none';
        }
    });
}

// Adicionar animação CSS
const style = document.createElement('style');
style.textContent = `
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }
    
    .contact-card {
        transition: all 0.3s ease;
    }
    
    .contact-card:hover {
        transform: translateY(-5px);
    }
    
    .btn-group .btn.active {
        background: linear-gradient(135deg, #667eea, #764ba2);
        border-color: #667eea;
        color: white;
    }
`;
document.head.appendChild(style);

// Auto-refresh a cada 30 segundos
setInterval(() => {
    // Verificar se há novos contatos
    fetch(window.location.href)
        .then(response => response.text())
        .then(html => {
            const parser = new DOMParser();
            const doc = parser.parseFromString(html, 'text/html');
            const newContactsCount = doc.querySelectorAll('.contact-card').length;
            const currentContactsCount = document.querySelectorAll('.contact-card').length;
            
            if (newContactsCount > currentContactsCount) {
                // Mostrar notificação de novo contato
                const toast = document.createElement('div');
                toast.className = 'toast-notification';
                toast.innerHTML = `
                    <div class="alert alert-success alert-dismissible fade show position-fixed" style="top: 20px; right: 20px; z-index: 9999;">
                        <i class="fas fa-envelope me-2"></i>
                        Novo contato recebido! <a href="javascript:location.reload()" class="alert-link">Atualizar página</a>
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                `;
                document.body.appendChild(toast);
                
                // Remover após 5 segundos
                setTimeout(() => {
                    toast.remove();
                }, 5000);
            }
        })
        .catch(error => console.error('Erro ao verificar novos contatos:', error));
}, 30000);
</script>
{% endblock %}